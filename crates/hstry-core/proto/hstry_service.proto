syntax = "proto3";

package hstry.service;

// Search service for querying chat history.
service SearchService {
  rpc Search(SearchRequest) returns (SearchResponse);
}

// Write service for external writers (e.g., Octo) to persist messages.
// This is the primary API for real-time message persistence.
service WriteService {
  // Upsert a conversation and its messages.
  // Uses source_id + external_id for deduplication.
  rpc WriteConversation(WriteConversationRequest) returns (WriteConversationResponse);
  
  // Append messages to an existing conversation.
  rpc AppendMessages(AppendMessagesRequest) returns (AppendMessagesResponse);
  
  // Upload binary data (images, audio, etc.) to attachments table.
  // Returns attachment_id to use in MediaSource.AttachmentRef.
  rpc UploadAttachment(UploadAttachmentRequest) returns (UploadAttachmentResponse);
}

// Read service for retrieving conversations and messages.
service ReadService {
  rpc GetConversation(GetConversationRequest) returns (GetConversationResponse);
  rpc GetMessages(GetMessagesRequest) returns (GetMessagesResponse);
  rpc ListConversations(ListConversationsRequest) returns (ListConversationsResponse);
}

enum SearchMode {
  SEARCH_MODE_AUTO = 0;
  SEARCH_MODE_NATURAL = 1;
  SEARCH_MODE_CODE = 2;
}

message SearchRequest {
  string query = 1;
  int64 limit = 2;
  int64 offset = 3;
  string source = 4;
  string workspace = 5;
  SearchMode mode = 6;
}

message SearchHit {
  string message_id = 1;
  string conversation_id = 2;
  int32 message_idx = 3;
  string role = 4;
  string content = 5;
  string snippet = 6;
  int64 created_at_ms = 7;
  int64 conv_created_at_ms = 8;
  int64 conv_updated_at_ms = 9;
  float score = 10;
  string source_id = 11;
  string external_id = 12;
  string title = 13;
  string workspace = 14;
  string source_adapter = 15;
  string source_path = 16;
  string host = 17;
}

message SearchResponse {
  repeated SearchHit hits = 1;
}

// ============================================================================
// Write Service Messages
// ============================================================================

message Conversation {
  string source_id = 1;           // e.g., "pi"
  string external_id = 2;         // Agent session ID (e.g., "ses_abc123")
  optional string title = 3;
  int64 created_at_ms = 4;
  optional int64 updated_at_ms = 5;
  optional string model = 6;
  optional string provider = 7;
  optional string workspace = 8;
  optional int64 tokens_in = 9;
  optional int64 tokens_out = 10;
  optional double cost_usd = 11;
  string metadata_json = 12;      // JSON string
}

message Message {
  int32 idx = 1;                  // Message index in conversation
  string role = 2;                // "user", "assistant", "system", "tool"
  string content = 3;             // Flattened text content
  string parts_json = 4;          // JSON array of Part objects
  optional int64 created_at_ms = 5;
  optional string model = 6;
  optional int64 tokens = 7;
  optional double cost_usd = 8;
  string metadata_json = 9;       // JSON string
}

message WriteConversationRequest {
  Conversation conversation = 1;
  repeated Message messages = 2;
}

message WriteConversationResponse {
  string conversation_id = 1;     // UUID assigned by hstry
  int32 messages_written = 2;
}

message AppendMessagesRequest {
  string source_id = 1;
  string external_id = 2;         // Identifies the conversation
  repeated Message messages = 3;
  optional int64 updated_at_ms = 4;
}

message AppendMessagesResponse {
  string conversation_id = 1;
  int32 messages_written = 2;
}

message UploadAttachmentRequest {
  string message_id = 1;          // UUID of the message
  string mime_type = 2;
  optional string filename = 3;
  bytes data = 4;                 // Binary content
}

message UploadAttachmentResponse {
  string attachment_id = 1;       // UUID to use in MediaSource.AttachmentRef
}

// ============================================================================
// Read Service Messages
// ============================================================================

message ConversationSummary {
  Conversation conversation = 1;
  int64 message_count = 2;
  string first_user_message = 3;
}

message GetConversationRequest {
  string source_id = 1;
  string external_id = 2;
  string readable_id = 3;
  string conversation_id = 4;
  string workspace = 5;
}

message GetConversationResponse {
  optional Conversation conversation = 1;
}

message GetMessagesRequest {
  string source_id = 1;
  string external_id = 2;
  string readable_id = 3;
  string conversation_id = 4;
  string workspace = 5;
  int64 limit = 6;
}

message GetMessagesResponse {
  string conversation_id = 1;
  repeated Message messages = 2;
}

message ListConversationsRequest {
  string source_id = 1;
  string workspace = 2;
  int64 limit = 3;
  int64 offset = 4;
}

message ListConversationsResponse {
  repeated ConversationSummary conversations = 1;
}
